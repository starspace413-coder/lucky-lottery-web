<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° æ¨‚é€å¹¸é‹è™Ÿç¢¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); min-height: 100vh; padding: 15px; color: #fff; }
        .container { max-width: 550px; margin: 0 auto; }
        h1 { text-align: center; font-size: 1.8em; background: linear-gradient(45deg, #ffd700, #ff8c00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 12px; }
        .mode-btns { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; }
        .mode-btn { flex: 1; min-width: 60px; padding: 10px 5px; border: 2px solid transparent; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; font-size: 0.8em; }
        .mode-btn.active { border-color: #ffd700; background: rgba(255,215,0,0.2); }
        .lotto-type-btns { display: flex; gap: 5px; margin-bottom: 15px; }
        .lotto-btn { flex: 1; padding: 8px; border: 2px solid transparent; border-radius: 8px; background: rgba(255,255,255,0.1); color: #aaa; cursor: pointer; font-size: 0.75em; }
        .lotto-btn.active { border-color: #00ff7f; color: #00ff7f; background: rgba(0,255,127,0.1); }
        .numbers { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .ball { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; background: linear-gradient(145deg, #667eea, #764ba2); animation: float 2s infinite; }
        .ball.special { background: linear-gradient(145deg, #f093fb, #f5576c); }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
        .special-text { text-align: center; color: #f5576c; font-weight: bold; margin-top: 8px; }
        .btn { background: linear-gradient(45deg, #ffd700, #ff8c00); border: none; padding: 12px 25px; font-size: 1em; border-radius: 20px; cursor: pointer; color: #1a1a2e; font-weight: bold; margin: 5px; }
        .btn-outline { background: transparent; border: 2px solid #ffd700; color: #ffd700; }
        .tags { text-align: center; margin-top: 10px; }
        .tag { display: inline-block; padding: 5px 10px; border-radius: 12px; font-size: 0.75em; margin: 2px; }
        .tag-yes { background: rgba(0,255,127,0.2); color: #00ff7f; }
        .tag-no { background: rgba(255,99,71,0.2); color: #ff6347; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2em; font-weight: bold; color: #ffd700; }
        .stat-label { font-size: 0.7em; color: #aaa; }
        .num-list { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
        .num-tag { padding: 4px 8px; border-radius: 10px; font-size: 0.75em; }
        .num-hot { background: rgba(255,107,107,0.3); color: #ff6b6b; }
        .num-cold { background: rgba(78,205,196,0.3); color: #4ecdc4; }
        .fav-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { background: rgba(255,99,71,0.3); border: none; color: #ff6347; padding: 4px 8px; border-radius: 8px; cursor: pointer; }
        .tips { text-align: center; color: #666; font-size: 0.65em; margin-top: 15px; padding: 10px; background: rgba(255,0,0,0.1); border-radius: 8px; }
        .chart-container { position: relative; height: 180px; margin-top: 10px; }
        .trend-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .trend-controls { display: flex; gap: 5px; }
        .trend-btn { padding: 4px 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: transparent; color: #aaa; font-size: 0.7em; cursor: pointer; }
        .trend-btn.active { border-color: #ffd700; color: #ffd700; }
        .jackpot { text-align: center; padding: 10px; background: linear-gradient(45deg, rgba(255,215,0,0.2), rgba(255,140,0,0.2)); border-radius: 10px; margin-bottom: 12px; }
        .jackpot-label { font-size: 0.7em; color: #aaa; }
        .jackpot-val { font-size: 1.4em; font-weight: bold; color: #ffd700; }
        .heatmap { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin-top: 10px; }
        .heatmap-cell { aspect-ratio: 1; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; }
        .pair-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 10px; }
        .pair-item { background: rgba(255,255,255,0.05); padding: 8px 3px; border-radius: 6px; text-align: center; }
        .pair-nums { font-size: 0.85em; color: #ffd700; }
        .pair-count { font-size: 0.65em; color: #aaa; }
        .odd-even { display: flex; justify-content: space-around; margin-top: 10px; }
        .oe-item { text-align: center; }
        .oe-bar { width: 30px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 4px; position: relative; overflow: hidden; }
        .oe-fill { position: absolute; bottom: 0; width: 100%; transition: height 0.5s; }
        .oe-fill.odd { background: linear-gradient(to top, #667eea, #764ba2); }
        .oe-fill.even { background: linear-gradient(to top, #f093fb, #f5576c); }
        .oe-label { font-size: 0.7em; color: #aaa; margin-top: 5px; }
        .history-toggle { text-align: center; margin-bottom: 10px; }
        .history-toggle button { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #aaa; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 0.8em; }
        .zodiac-btns { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 12px; }
        .zodiac-btn { padding: 8px 4px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; background: rgba(255,255,255,0.05); color: #aaa; cursor: pointer; font-size: 0.65em; text-align: center; }
        .zodiac-btn.active { border-color: #ffd700; color: #ffd700; background: rgba(255,215,0,0.1); }
        .horoscope { background: linear-gradient(135deg, rgba(100,100,200,0.2), rgba(150,100,200,0.2)); }
        .horo-title { font-size: 1em; text-align: center; margin-bottom: 10px; }
        .horo-name { font-size: 1.2em; color: #ffd700; font-weight: bold; }
        .horo-lucky { display: flex; justify-content: center; gap: 15px; margin: 10px 0; }
        .horo-luckyi { padding: 5px 10px; background: rgba(0,255,127,0.1); border-radius: 8px; font-size: 0.75em; }
        .horo-luckyj { padding: 5px 10px; background: rgba(255,99,71,0.1); border-radius: 8px; font-size: 0.75em; }
        .horo-scores { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; }
        .horo-score { text-align: center; padding: 8px 3px; background: rgba(255,255,255,0.05); border-radius: 6px; }
        .horo-score-val { font-size: 1em; font-weight: bold; color: #ffd700; }
        .horo-score-label { font-size: 0.6em; color: #aaa; }
        .horo-comment { font-size: 0.7em; color: #aaa; text-align: center; margin-top: 10px; font-style: italic; }
        .history-list { max-height: 200px; overflow-y: auto; display: none; }
        .history-list.show { display: block; }
        .history-item { display: flex; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 5px; font-size: 0.8em; }
        .history-period { color: #888; }
        .history-nums { color: #ffd700; }
        .section-title { font-size: 0.9em; margin-bottom: 8px; }
        .daily-lucky { text-align: center; padding: 15px; background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.1)); border-radius: 12px; margin-bottom: 12px; }
        .daily-label { font-size: 0.7em; color: #aaa; }
        .daily-nums { font-size: 1.3em; color: #ffd700; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° æ¨‚é€å¹¸é‹è™Ÿç¢¼</h1>
        
        <div class="card">
            <div class="lotto-type-btns">
                <button class="lotto-btn active" data-type="649">å¤§æ¨‚é€</button>
                <button class="lotto-btn" data-type="539">ä»Šå½©539</button>
                <button class="lotto-btn" data-type="power">å¨åŠ›å½©</button>
            </div>
        </div>
        
        <div class="jackpot">
            <div class="jackpot-label">ğŸ’° é ­çç´¯ç©çé‡‘</div>
            <div class="jackpot-val" id="jackpot">NT$ 1.2 å„„</div>
        </div>
        
        <!-- æ˜Ÿåº§é‹å‹¢ -->
        <div class="card horoscope">
            <div class="horo-title"><span class="horo-name" id="horoName">ç™½ç¾Šåº§</span> ä»Šæ—¥é‹å‹¢</div>
            <div class="zodiac-btns" id="zodiacBtns"></div>
            <div class="horo-lucky">
                <span class="horo-luckyi" id="horoYi">å®œï¼š-</span>
                <span class="horo-luckyj" id="horoJi">å¿Œï¼š-</span>
            </div>
            <div class="horo-scores">
                <div class="horo-score"><div class="horo-score-val" id="scoreAll">-</div><div class="horo-score-label">æ•´é«”</div></div>
                <div class="horo-score"><div class="horo-score-val" id="scoreLove">-</div><div class="horo-score-label">æ„›æƒ…</div></div>
                <div class="horo-score"><div class="horo-score-val" id="scoreMoney">-</div><div class="horo-score-label">è²¡é‹</div></div>
                <div class="horo-score"><div class="horo-score-val" id="scoreWork">-</div><div class="horo-score-label">äº‹æ¥­</div></div>
                <div class="horo-score"><div class="horo-score-val" id="scoreHealth">-</div><div class="horo-score-label">å¥åº·</div></div>
            </div>
            <div class="horo-comment" id="horoComment"></div>
        </div>
        
        <div class="card">
            <div class="daily-lucky">
                <div class="daily-label">ğŸ² ä»Šæ—¥å¹¸é‹è™Ÿç¢¼</div>
                <div class="daily-nums" id="dailyLucky">-</div>
            </div>
        </div>
        
        <div class="card">
            <div style="font-size:0.75em;color:#aaa;text-align:center;margin-bottom:10px;">
                ğŸ“Š æ¡ç”¨çµ±è¨ˆè«–æ–‡æ¨¡å‹ | é€£è™Ÿæ©Ÿç‡ 56% | é‡è¤‡æ©Ÿç‡ 20%
            </div>
            <div class="mode-btns">
                <button class="mode-btn active" data-mode="balanced">âš–ï¸å¹³è¡¡</button>
                <button class="mode-btn" data-mode="hot">ğŸ”¥ç†±é–€</button>
                <button class="mode-btn" data-mode="cold">â„ï¸å†·é–€</button>
                <button class="mode-btn" data-mode="drag">ğŸ“Œæ‹–ç‰Œ</button>
            </div>
            
            <div class="numbers" id="numbers"></div>
            <p class="special-text">â­ ç‰¹åˆ¥è™Ÿ: <span id="special">-</span> <span id="special2Zone" style="display:none">| ç¬¬äºŒå€: <span id="special2">-</span></span></p>
            
            <div class="tags">
                <span class="tag" id="consTag"></span>
                <span class="tag" id="repeatTag"></span>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" id="genBtn">ğŸ”„ é‡æ–°ç”¢ç”Ÿ</button>
                <button class="btn btn-outline" id="favBtn">â¤ï¸æ”¶è—</button>
            </div>
        </div>
        
        <div class="card">
            <div class="section-title">ğŸ“Š å¥‡å¶æ¯”ä¾‹</div>
            <div class="odd-even">
                <div class="oe-item">
                    <div class="oe-bar"><div class="oe-fill odd" id="oddBar" style="height:50%"></div></div>
                    <div class="oe-label">å¥‡æ•¸ <span id="oddCount">3</span></div>
                </div>
                <div class="oe-item">
                    <div class="oe-bar"><div class="oe-fill even" id="evenBar" style="height:50%"></div></div>
                    <div class="oe-label">å¶æ•¸ <span id="evenCount">3</span></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="stats">
                <div class="stat"><div class="stat-val" id="consRate">-</div><div class="stat-label">é€£è™Ÿæ©Ÿç‡</div></div>
                <div class="stat"><div class="stat-val" id="repeatRate">-</div><div class="stat-label">é‡è¤‡æ©Ÿç‡</div></div>
                <div class="stat"><div class="stat-val" id="totalDraws">-</div><div class="stat-label">åˆ†ææœŸæ•¸</div></div>
            </div>
        </div>
        
        <div class="card">
            <div class="trend-title">
                <div style="font-size:0.9em;">ğŸ“ˆ è¶¨å‹¢åœ–ï¼ˆæ»‘å‹•çª—å€é–“ï¼‰</div>
                <div class="trend-controls">
                    <button class="trend-btn active" data-num="hot">ğŸ”¥ç†±é–€</button>
                    <button class="trend-btn" data-num="cold">â„ï¸å†·é–€</button>
                </div>
            </div>
            <div style="font-size:0.65em;color:#888;margin-bottom:5px;">æ©«è»¸ï¼šæœŸæ•¸ï¼ˆèˆŠâ†’æ–°ï¼‰ | ç¸±è»¸ï¼šé–‹å‡ºæ¬¡æ•¸</div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="section-title">ğŸ”¥ è™Ÿç¢¼ç†±åŠ›åœ–</div>
            <div class="heatmap" id="heatmap"></div>
        </div>
        
        <div class="card">
            <div class="section-title">ğŸ”— è™Ÿç¢¼å°æ•¸ TOP10</div>
            <div class="pair-grid" id="pairGrid"></div>
        </div>
        
        <div class="card">
            <div style="font-size:0.9em;margin-bottom:8px;">ğŸ”¥ ç†±é–€è™Ÿç¢¼ TOP10</div>
            <div class="num-list" id="hotNums"></div>
        </div>
        
        <div class="card">
            <div style="font-size:0.9em;margin-bottom:8px;">â„ï¸ å†·é–€è™Ÿç¢¼ TOP10</div>
            <div class="num-list" id="coldNums"></div>
        </div>
        
        <div class="card">
            <div class="history-toggle">
                <button id="toggleHistory">ğŸ“‹ å±•é–‹æ­·å²ç´€éŒ„ â–¾</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
        
        <div class="card">
            <div style="font-size:0.9em;margin-bottom:8px;">â¤ï¸ æˆ‘çš„æ”¶è—</div>
            <div id="favList"></div>
        </div>
        
        <div class="tips">âš ï¸ æ¨‚é€ç‚ºå®Œå…¨éš¨æ©Ÿï¼Œæ­¤åƒ…ä¾›å¨›æ¨‚åƒè€ƒ</div>
    </div>

    <script>
    const LOTTO_CONFIG = {
        '649': { name: 'å¤§æ¨‚é€', maxNum: 49, pickNum: 6, special: true, special2: false, jackpot: '1.2 å„„' },
        '539': { name: 'ä»Šå½©539', maxNum: 39, pickNum: 5, special: false, special2: false, jackpot: '800 è¬' },
        'power': { name: 'å¨åŠ›å½©', maxNum: 38, pickNum: 6, special: true, special2: true, special2Max: 8, jackpot: '3.2 å„„' }
    };
    
    const ZODIAC_SIGNS = [
        { id: 'aries', name: 'ç™½ç¾Š', emoji: 'â™ˆ' },
        { id: 'taurus', name: 'é‡‘ç‰›', emoji: 'â™‰' },
        { id: 'gemini', name: 'é›™å­', emoji: 'â™Š' },
        { id: 'cancer', name: 'å·¨èŸ¹', emoji: 'â™‹' },
        { id: 'leo', name: 'ç…å­', emoji: 'â™Œ' },
        { id: 'virgo', name: 'è™•å¥³', emoji: 'â™' },
        { id: 'libra', name: 'å¤©ç§¤', emoji: 'â™' },
        { id: 'scorpio', name: 'å¤©è ', emoji: 'â™' },
        { id: 'sagittarius', name: 'å°„æ‰‹', emoji: 'â™' },
        { id: 'capricorn', name: 'æ‘©ç¾¯', emoji: 'â™‘' },
        { id: 'aquarius', name: 'æ°´ç“¶', emoji: 'â™’' },
        { id: 'pisces', name: 'é›™é­š', emoji: 'â™“' }
    ];
    
    let currentZodiac = 'aries';
    let horoscopeData = null;
    
    let data = [];
    let stats = { counter: {}, hot: [], cold: [], trends: {}, pairs: {}, oddCount: 0, evenCount: 0, maxCount: 1 };
    let currentType = '649';
    let currentMode = 'balanced';
    let currentTrendNum = 'hot';
    let currentNums = [];
    let currentSpecial = 0;
    let currentSpecial2 = 0;
    let chart = null;
    
    const CONS_RATE = 0.56;
    const REPEAT_RATE = 0.20;
    const WINDOW_SIZE = 20;
    const REF_POINTS = 20;
    
    init();
    
    async function init() {
        data = [];  // ç¢ºä¿åˆå§‹ä¹¾æ·¨
        await loadData();
        analyze();
        generate();
        renderDailyLucky();
        renderFavorites();
        renderHeatmap();
        renderPairs();
        renderHistory();
        renderZodiacButtons();
        loadHoroscope(currentZodiac);
        // åˆå§‹è¶¨å‹¢åœ–é¡¯ç¤ºç”¢ç”Ÿçš„è™Ÿç¢¼
        updateTrendChartForNumbers(currentNums);
        
        document.querySelectorAll('.lotto-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.lotto-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentType = btn.dataset.type;
                updateLottoType();
            };
        });
        
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                generate();
            };
        });
        
        document.querySelectorAll('.trend-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.trend-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTrendNum = btn.dataset.num;
                updateTrendChart();
            };
        });
        
        document.getElementById('toggleHistory').onclick = () => {
            const list = document.getElementById('historyList');
            const btn = document.getElementById('toggleHistory');
            list.classList.toggle('show');
            btn.innerHTML = list.classList.contains('show') ? 'ğŸ“‹ æ”¶åˆæ­·å²ç´€éŒ„ â–´' : 'ğŸ“‹ å±•é–‹æ­·å²ç´€éŒ„ â–¾';
        };
        
        document.getElementById('genBtn').onclick = generate;
        document.getElementById('favBtn').onclick = saveFav;
    }
    
    function updateLottoType() {
        const config = LOTTO_CONFIG[currentType];
        document.getElementById('jackpot').textContent = 'NT$ ' + config.jackpot;
        // é‡æ–°è¼‰å…¥è©²å½©åˆ¸çš„è³‡æ–™
        data = [];
        loadData().then(() => {
            analyze();
            generate();
            updateTrendChartForNumbers(currentNums);
            renderHeatmap();
            renderPairs();
            renderHistory();
            renderDailyLucky();  // æ›´æ–°æ¯æ—¥å¹¸é‹è™Ÿç¢¼
        });
    }
    
    async function loadData() {
        const config = LOTTO_CONFIG[currentType];
        
        // ç¢ºä¿è³‡æ–™é™£åˆ—æ˜¯ç©ºçš„
        data = [];
        
        // æ ¹æ“šå½©åˆ¸é¡å‹ä½¿ç”¨å°æ‡‰çš„ API
        const apiMap = {
            '649': 'Lotto649Result',
            '539': 'Lotto539Result', 
            'power': 'SuperLottoResult'
        };
        
        const apiName = apiMap[currentType] || 'Lotto649Result';
        const months = ['2025-09','2025-10','2025-11','2025-12','2026-01','2026-02'];
        
        for (let m of months) {
            try {
                let r = await fetch('https://api.taiwanlottery.com/TLCAPIWeB/Lottery/' + apiName + '?period&month=' + m + '&pageNum=1&pageSize=50');
                let d = await r.json();
                
                // æ ¹æ“šä¸åŒ API å›æ‡‰æ ¼å¼è™•ç†
                if (currentType === '649' && d.content && d.content.lotto649Res) {
                    data.push(...d.content.lotto649Res);
                } else if (currentType === '539' && d.content && d.content.lotto539Res) {
                    data.push(...d.content.lotto539Res);
                } else if (currentType === 'power' && d.content && d.content.superLottoRes) {
                    data.push(...d.content.superLottoRes);
                }
            } catch(e) {
                console.log('API error:', e);
            }
        }
        
        data.sort((a, b) => a.lottoPeriodNo - b.lottoPeriodNo);
        
        if (data.length < 10) {
            generateSampleData();
        }
    }
    
    function generateSampleData() {
        const config = LOTTO_CONFIG[currentType];
        for (let i = 0; i < 50; i++) {
            let nums = [];
            while (nums.length < config.pickNum) {
                let n = Math.floor(Math.random() * config.maxNum) + 1;
                if (!nums.includes(n)) nums.push(n);
            }
            // å¨åŠ›å½©æœ‰ç¬¬äºŒå€
            let special2 = config.special2 ? Math.floor(Math.random() * config.special2Max) + 1 : null;
            data.push({ drawNumberSize: nums.sort((a,b)=>a-b), special2: special2 });
        }
    }
    
    function analyze() {
        const config = LOTTO_CONFIG[currentType];
        let main = [], special = [], cons = 0, repeat = 0, prev = null;
        let odd = 0, even = 0;
        let pairs = {};
        
        data.forEach(d => {
            let nums = d.drawNumberSize || [];
            if (nums.length >= config.pickNum) {
                let m = nums.slice(0, config.pickNum).sort((a,b)=>a-b);
                main.push(...m);
                if (config.special) special.push(nums[config.pickNum]);
                
                m.forEach(n => n % 2 === 0 ? even++ : odd++);
                
                for (let i = 0; i < m.length-1; i++) {
                    if (m[i+1] - m[i] === 1) cons++;
                }
                
                if (prev) {
                    let c = m.filter(x => prev.includes(x)).length;
                    if (c >= 2) repeat++;
                }
                
                for (let i = 0; i < m.length; i++) {
                    for (let j = i+1; j < m.length; j++) {
                        let key = [m[i], m[j]].sort((a,b)=>a-b).join('-');
                        pairs[key] = (pairs[key] || 0) + 1;
                    }
                }
                
                prev = m;
            }
        });
        
        let counter = {};
        main.forEach(n => counter[n] = (counter[n] || 0) + 1);
        
        let sorted = Object.entries(counter).sort((a,b) => b[1] - a[1]);
        let maxCount = sorted.length > 0 ? sorted[0][1] : 1;
        
        stats = { 
            counter, 
            hot: sorted.slice(0,10).map(x=>parseInt(x[0])), 
            cold: sorted.slice(-10).reverse().map(x=>parseInt(x[0])),
            trends: {},
            pairs: Object.entries(pairs).sort((a,b) => b[1] - a[1]).slice(0, 12),
            oddCount: odd,
            evenCount: even,
            maxCount: maxCount
        };
        
        calculateTrends();
        
        document.getElementById('consRate').textContent = (cons / data.length * 100).toFixed(1) + '%';
        document.getElementById('repeatRate').textContent = (repeat / Math.max(1, data.length-1) * 100).toFixed(1) + '%';
        document.getElementById('totalDraws').textContent = data.length;
        document.getElementById('hotNums').innerHTML = stats.hot.map(n => '<span class="num-tag num-hot">' + n + '</span>').join('');
        document.getElementById('coldNums').innerHTML = stats.cold.map(n => '<span class="num-tag num-cold">' + n + '</span>').join('');
        
        let totalOE = stats.oddCount + stats.evenCount;
        let oddPct = totalOE > 0 ? (stats.oddCount / totalOE * 100) : 50;
        let evenPct = totalOE > 0 ? (stats.evenCount / totalOE * 100) : 50;
        document.getElementById('oddBar').style.height = oddPct + '%';
        document.getElementById('evenBar').style.height = evenPct + '%';
        document.getElementById('oddCount').textContent = Math.round(oddPct) + '%';
        document.getElementById('evenCount').textContent = Math.round(evenPct) + '%';
    }
    
    function calculateTrends() {
        const config = LOTTO_CONFIG[currentType];
        let mainNums = data.map(d => (d.drawNumberSize || []).slice(0, config.pickNum)).filter(n => n.length >= config.pickNum);
        let totalPeriods = mainNums.length;
        
        for (let num = 1; num <= config.maxNum; num++) {
            let trends = [];
            for (let i = 0; i < REF_POINTS; i++) {
                let start = Math.max(0, totalPeriods - WINDOW_SIZE - i);
                let end = totalPeriods - i;
                if (start < end) {
                    let count = 0;
                    for (let j = start; j < end; j++) {
                        if (mainNums[j].includes(num)) count++;
                    }
                    trends.push(count);
                }
            }
            if (trends.length > 0) stats.trends[num] = trends;
        }
    }
    
    function renderHeatmap() {
        const config = LOTTO_CONFIG[currentType];
        let html = '';
        for (let i = 1; i <= config.maxNum; i++) {
            let count = stats.counter[i] || 0;
            let intensity = stats.maxCount > 0 ? count / stats.maxCount : 0;
            let r = Math.round(255 * intensity);
            let g = Math.round(100 * (1 - intensity));
            let b = Math.round(100 * (1 - intensity));
            let bg = 'rgba(' + r + ',' + g + ',' + b + ',0.6)';
            let color = intensity > 0.5 ? '#fff' : '#aaa';
            html += '<div class="heatmap-cell" style="background:' + bg + ';color:' + color + '">' + i + '</div>';
        }
        document.getElementById('heatmap').innerHTML = html;
    }
    
    function renderPairs() {
        let html = stats.pairs.slice(0, 12).map(p => {
            let nums = p[0].split('-');
            return '<div class="pair-item"><div class="pair-nums">' + nums[0] + '-' + nums[1] + '</div><div class="pair-count">' + p[1] + 'æ¬¡</div></div>';
        }).join('');
        document.getElementById('pairGrid').innerHTML = html;
    }
    
    function renderTrendChart() {
        let ctx = document.getElementById('trendChart').getContext('2d');
        let numbers = currentTrendNum === 'hot' ? stats.hot.slice(0,5) : stats.cold.slice(0,5);
        let datasets = numbers.map((num, i) => {
            let trend = stats.trends[num] || [];
            let color = currentTrendNum === 'hot' ? 
                'rgba(255,' + (100 + i*30) + ',' + (100 + i*30) + ',1)' : 
                'rgba(78,' + (205 - i*20) + ',' + (196 - i*20) + ',1)';
            return {
                label: 'è™Ÿç¢¼ ' + num,
                data: trend,
                borderColor: color,
                backgroundColor: color.replace('1)', '0.1)'),
                fill: true,
                tension: 0.3,
                borderWidth: 2
            };
        });
        
        let avgData = [];
        if (datasets.length > 0 && datasets[0].data.length > 0) {
            let len = datasets[0].data.length;
            for (let i = 0; i < len; i++) {
                let sum = datasets.reduce((acc, d) => acc + (d.data[i] || 0), 0);
                avgData.push(sum / datasets.length);
            }
        }
        
        let labels = datasets.length > 0 ? datasets[0].data.map((_, i) => 'æœŸ'+(i+1)) : [];
        
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    ...datasets,
                    { label: 'å¹³å‡', data: avgData, borderColor: 'rgba(0,255,127,0.8)', borderDash: [5,5], borderWidth: 2, pointRadius: 0, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'bottom', labels: { color: '#aaa', boxWidth: 12, font: { size: 10 } } } },
                scales: {
                    x: { ticks: { color: '#888', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#888', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
                }
            }
        });
    }
    
    function updateTrendChart() {
        if (chart) chart.destroy();
        renderTrendChart();
    }
    
    function updateTrendChartForNumbers(numbers) {
        if (chart) chart.destroy();
        
        let ctx = document.getElementById('trendChart').getContext('2d');
        // ä½¿ç”¨ç•¶æ¬¡ç”¢ç”Ÿçš„è™Ÿç¢¼
        let numsToShow = numbers.slice(0, 5); // æœ€å¤šé¡¯ç¤º5å€‹
        
        let datasets = numsToShow.map((num, i) => {
            let trend = stats.trends[num] || [];
            // ç”¢ç”Ÿæ¼¸å±¤é¡è‰²
            let hue = (i * 60) % 360;
            let color = 'hsla(' + hue + ', 70%, 60%, 1)';
            return {
                label: 'è™Ÿç¢¼ ' + num,
                data: trend,
                borderColor: color,
                backgroundColor: color.replace('1)', '0.1)'),
                fill: true,
                tension: 0.3,
                borderWidth: 2
            };
        });
        
        // å¹³å‡ç·š
        let avgData = [];
        if (datasets.length > 0 && datasets[0].data.length > 0) {
            let len = datasets[0].data.length;
            for (let i = 0; i < len; i++) {
                let sum = datasets.reduce((acc, d) => acc + (d.data[i] || 0), 0);
                avgData.push(sum / datasets.length);
            }
        }
        
        let labels = datasets.length > 0 ? datasets[0].data.map((_, i) => 'æœŸ' + (i+1)) : [];
        
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    ...datasets,
                    { label: 'å¹³å‡', data: avgData, borderColor: 'rgba(0,255,127,0.8)', borderDash: [5,5], borderWidth: 2, pointRadius: 0, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        display: true, 
                        position: 'bottom', 
                        labels: { color: '#aaa', boxWidth: 12, font: { size: 10 } } 
                    },
                    title: {
                        display: true,
                        text: 'ğŸ“ˆ ç•¶æ¬¡ç”¢ç”Ÿè™Ÿç¢¼çš„æ­·å²è¶¨å‹¢',
                        color: '#ffd700',
                        font: { size: 12 }
                    }
                },
                scales: {
                    x: { ticks: { color: '#888', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#888', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
                }
            }
        });
    }
    
    function renderHistory() {
        let html = data.slice(0, 20).reverse().map(d => {
            let nums = (d.drawNumberSize || []).slice(0, 6).join(', ');
            return '<div class="history-item"><span class="history-period">' + (d.lottoPeriodNo || '?') + '</span><span class="history-nums">' + nums + '</span></div>';
        }).join('');
        document.getElementById('historyList').innerHTML = html || '<p style="color:#888;text-align:center;">ç„¡æ­·å²è³‡æ–™</p>';
    }
    
    function renderZodiacButtons() {
        let html = ZODIAC_SIGNS.map(z => 
            '<div class="zodiac-btn' + (z.id === currentZodiac ? ' active' : '') + '" data-id="' + z.id + '">' + z.emoji + ' ' + z.name + '</div>'
        ).join('');
        document.getElementById('zodiacBtns').innerHTML = html;
        
        document.querySelectorAll('.zodiac-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.zodiac-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentZodiac = btn.dataset.id;
                loadHoroscope(currentZodiac);
            };
        });
    }
    
    async function loadHoroscope(zodiac) {
        // ç°¡é«”è½‰ç¹é«”
        const s2t = s => s ? s.replace(/äº/g,'æ–¼').replace(/ä¸‡/g,'è¬').replace(/ä¸/g,'èˆ‡').replace(/ä¸º/g,'ç‚º').replace(/æ— /g,'ç„¡').replace(/å¼€/g,'é–‹').replace(/è§/g,'è¦‹').replace(/è´/g,'è²').replace(/è´/g,'è²').replace(/è´¢/g,'è²¡').replace(/è´¡/g,'è²¢').replace(/è´¤/g,'è³¢').replace(/è´¨/g,'è³ª').replace(/è´©/g,'è²©').replace(/è´ª/g,'è²ª').replace(/è´­/g,'è³¼').replace(/è´®/g,'è²¯').replace(/è´±/g,'è³¤').replace(/è´´/g,'è²¼').replace(/è´·/g,'è²¸').replace(/è´º/g,'è³€').replace(/è´¾/g,'è³ˆ').replace(/è´¼/g,'è³Š').replace(/å€º/g,'å‚µ').replace(/å€¾/g,'å‚¾').replace(/ä¾¦/g,'åµ').replace(/å‚¨/g,'å„²').replace(/å…»/g,'é¤Š').replace(/å‡€/g,'æ·¨').replace(/å‡»/g,'æ“Š').replace(/å‰§/g,'åŠ‡').replace(/åŠ¨/g,'å‹•').replace(/åŠ¡/g,'å‹™').replace(/åŠ³/g,'å‹').replace(/åŠ¿/g,'å‹¢').replace(/åŒº/g,'å€').replace(/å/g,'å”').replace(/å•/g,'å–®').replace(/å–/g,'è³£').replace(/åš/g,'åš').replace(/åœ/g,'åœ').replace(/å«/g,'è¡›').replace(/å¿/g,'ç¸£').replace(/å‚/g,'åƒ').replace(/å‘/g,'ç™¼').replace(/å˜/g,'è®Š').replace(/å /g,'ç–Š').replace(/å°/g,'è‡º').replace(/å•/g,'å‘‚').replace(/å¬/g,'è½').replace(/å¯/g,'å•Ÿ').replace(/å´/g,'å³').replace(/éª‚/g,'ç½µ').replace(/åœ†/g,'åœ“').replace(/åœº/g,'å ´').replace(/å—/g,'å¡Š').replace(/å›/g,'å£‡').replace(/å /g,'å¢œ').replace(/å’/g,'å£˜').replace(/å«/g,'å¢Š').replace(/å¤‡/g,'å‚™').replace(/å¤/g,'è¤‡').replace(/å¤„/g,'è™•').replace(/å¤´/g,'é ­').replace(/ä¹°/g,'è²·').replace(/å–/g,'è³£').replace(/å­™/g,'å­«').replace(/å­¦/g,'å­¸').replace(/å®«/g,'å®®').replace(/å®½/g,'å¯¬').replace(/å®¾/g,'è³“').replace(/å¯¹/g,'å°').replace(/å¯»/g,'å°‹').replace(/å¯¼/g,'å°').replace(/å¯¿/g,'å£½').replace(/å°†/g,'å°‡').replace(/å°/g,'å˜—').replace(/å°§/g,'å ¯').replace(/åˆ™/g,'å‰‡').replace(/åˆš/g,'å‰›').replace(/åˆ›/g,'å‰µ').replace(/åˆ˜/g,'åŠ‰').replace(/åˆ«/g,'åˆ¥').replace(/å‰‘/g,'åŠ').replace(/å‰¥/g,'å‰').replace(/åŠ/g,'å‹¸').replace(/åŠ/g,'è¾¦').replace(/åŠ±/g,'å‹µ').replace(/åŠ²/g,'å‹').replace(/å‹‡/g,'å‹‡').replace(/å‡ /g,'å¹¾').replace(/å/g,'è¯').replace(/çˆ±/g,'æ„›').replace(/ä½“/g,'é«”').replace(/è¿/g,'é‹').replace(/å½“/g,'ç•¶').replace(/åº”/g,'æ‡‰').replace(/æ—¶é—´/g,'æ™‚é–“').replace(/è¿™/g,'é€™').replace(/é‚£/g,'é‚£').replace(/é‡Œ/g,'è£¡').replace(/ç­‰/g,'ç­‰').replace(/è®©/g,'è®“').replace(/è¿‡/g,'é').replace(/è¿˜/g,'é‚„').replace(/è¿›/g,'é€²').replace(/è¿œ/g,'é ').replace(/è¿/g,'é€£').replace(/è½¦/g,'è»Š').replace(/è½§/g,'è»‹').replace(/è½¨/g,'è»Œ').replace(/è½©/g,'è»’').replace(/è½½/g,'è¼‰').replace(/è½¿/g,'è½').replace(/è¾ƒ/g,'è¼ƒ').replace(/è¾‚/g,'è¼…').replace(/è¾Š/g,'è¼¥').replace(/è¾ˆ/g,'è¼©').replace(/è¾‰/g,'è¼').replace(/è¾/g,'è¼»').replace(/è¾“/g,'è¼¸').replace(/è¾­/g,'è¾­').replace(/è¾¹/g,'é‚Š').replace(/è¿/g,'é·').replace(/è¿/g,'é·').replace(/è¿/g,'é‹').replace(/è¿‡/g,'é').replace(/è¿/g,'é€£').replace(/é€¹/g,'é”').replace(/è¾¾/g,'é”').replace(/è¾/g,'è¾­').replace(/ä¸‘/g,'é†œ').replace(/ä¸“/g,'å°ˆ').replace(/ä¸”/g,'ä¸”').replace(/ä¸–/g,'ä¸–').replace(/ä¸š/g,'æ¥­').replace(/ä¸›/g,'å¢').replace(/ä¸œ/g,'æ±').replace(/ä¸/g,'çµ²').replace(/ä¸¢/g,'ä¸Ÿ').replace(/ä¸¤/g,'å…©').replace(/ä¸¥/g,'åš´').replace(/ä¸§/g,'å–ª').replace(/ä¸ª/g,'å€‹').replace(/ä¸´/g,'è‡¨').replace(/ä¸¸/g,'ä¸¸').replace(/ä¸¹/g,'ä¸¹').replace(/ä¸º/g,'ç‚º').replace(/ä¸»/g,'ä¸»').replace(/ä¸½/g,'éº—').replace(/ä¸¾/g,'èˆ‰').replace(/ä¹ˆ/g,'éº¼').replace(/ä¹‰/g,'ç¾©').replace(/ä¹‹/g,'ä¹‹').replace(/ä¹Œ/g,'çƒ').replace(/ä¹/g,'ä¹').replace(/ä¹/g,'ä¹').replace(/ä¹/g,'æ¨‚').replace(/ä¹’/g,'ä¹’').replace(/ä¹“/g,'ä¹“').replace(/ä¹–/g,'ä¹–').replace(/ä¹˜/g,'ä¹˜').replace(/ä¹™/g,'ä¹™').replace(/ä¹/g,'ä¹').replace(/ä¹/g,'ä¹').replace(/ä¹Ÿ/g,'ä¹Ÿ').replace(/ä¹ /g,'ç¿’').replace(/ä¹¡/g,'é„‰').replace(/ä¹¦/g,'æ›¸').replace(/ä¹°/g,'è²·').replace(/ä¹±/g,'äº‚').replace(/ä¹³/g,'ä¹³').replace(/äº†/g,'äº†').replace(/äºˆ/g,'äºˆ').replace(/äº‰/g,'çˆ­').replace(/äº‹/g,'äº‹').replace(/äºŒ/g,'äºŒ').replace(/äº/g,'æ–¼').replace(/äº/g,'è™§').replace(/äº‘/g,'é›²').replace(/äº’/g,'äº’').replace(/äº”/g,'äº”').replace(/äº•/g,'äº•').replace(/äºš/g,'äº').replace(/äº›/g,'äº›').replace(/äº¡/g,'äº¡').replace(/äº¢/g,'äº¢').replace(/äº¤/g,'äº¤').replace(/äº¥/g,'äº¥').replace(/äº¦/g,'äº¦').replace(/äº§/g,'ç”¢').replace(/äº¨/g,'äº¨').replace(/äº©/g,'ç•').replace(/äº«/g,'äº«').replace(/äº¬/g,'äº¬').replace(/äº­/g,'äº­').replace(/äº®/g,'äº®').replace(/äº²/g,'è¦ª').replace(/äºº/g,'äºº').replace(/äº¿/g,'å„„').replace(/ä»€/g,'ä»€').replace(/ä»/g,'ä»').replace(/ä»„/g,'ä»„').replace(/ä»†/g,'åƒ•').replace(/ä»‡/g,'ä»‡').replace(/ä»Š/g,'ä»Š').replace(/ä»‹/g,'ä»‹').replace(/ä»/g,'ä»').replace(/ä»/g,'å¾').replace(/ä»¨/g,'ä»¨').replace(/ä»/g,'ä»').replace(/ä»‘/g,'ä¾–').replace(/ä»“/g,'å€‰').replace(/ä»ª/g,'å„€').replace(/ä»¬/g,'å€‘').replace(/ä¼—/g,'çœ¾').replace(/ä¼˜/g,'å„ª').replace(/ä¼š/g,'æœƒ').replace(/ä¼/g,'å‚˜').replace(/ä¼Ÿ/g,'å‰').replace(/ä¼ /g,'å‚³').replace(/ä¼¤/g,'å‚·').replace(/ä¼¦/g,'å€«').replace(/ä¼ª/g,'å½').replace(/ä¼°/g,'ä¼°').replace(/ä½“/g,'é«”').replace(/ä½•/g,'ä½•').replace(/ä½™/g,'é¤˜').replace(/ä½›/g,'ä½›').replace(/ä½œ/g,'ä½œ').replace(/ä½ /g,'ä½ ').replace(/ä½©/g,'ä½©').replace(/ä½¬/g,'ä½¬').replace(/ä½³/g,'ä½³').replace(/ä½¿/g,'ä½¿').replace(/ä¾ /g,'ä¿ ').replace(/ä¾£/g,'ä¾¶').replace(/ä¾¥/g,'åƒ¥').replace(/ä¾¦/g,'åµ').replace(/ä¾§/g,'å´').replace(/ä¾¨/g,'åƒ‘').replace(/ä¿­/g,'å„‰').replace(/ä¿/g,'ä¿').replace(/ä¿‘/g,'ä¿‘').replace(/ä¿—/g,'ä¿—').replace(/ä¿˜/g,'ä¿˜').replace(/ä¿/g,'ä¿').replace(/ä¿/g,'ä¿').replace(/ä¿Ÿ/g,'ä¿Ÿ').replace(/ä¿®/g,'ä¿®').replace(/ä¿±/g,'ä¿±').replace(/ä¿š/g,'ä¿š').replace(/ä¿¸/g,'ä¿¸').replace(/ä¿¥/g,'ä¿¥').replace(/å€º/g,'å‚µ').replace(/è—‰/g,'è—‰').replace(/å‡³/g,'å‡³').replace(/åˆ€/g,'åˆ€').replace(/åˆ/g,'åˆ').replace(/åˆƒ/g,'åˆƒ').replace(/åˆ‡/g,'åˆ‡').replace(/åˆŠ/g,'åˆŠ').replace(/å‰Š/g,'å‰Š').replace(/å‰/g,'å‰®').replace(/å‰‘/g,'åŠ').replace(/åŠˆ/g,'åŠˆ').replace(/å‹ƒ/g,'å‹ƒ').replace(/å‹‡/g,'å‹‡').replace(/å‹‰/g,'å‹‰').replace(/å‹‹/g,'å‹³').replace(/å‹º/g,'å‹º').replace(/å‹¿/g,'å‹¿').replace(/åŒ/g,'åŒ').replace(/åŒ/g,'åŒ').replace(/åŒ/g,'åŒ').replace(/åŒ•/g,'åŒ•').replace(/åŒ–/g,'åŒ–').replace(/åŒ—/g,'åŒ—').replace(/åŒ™/g,'åŒ™').replace(/åŒ/g,'åŒ').replace(/åŒ /g,'åŒ ').replace(/åŒ¡/g,'åŒ¡').replace(/åŒ£/g,'åŒ£').replace(/åŒª/g,'åŒª').replace(/åŒ®/g,'åŒ±').replace(/åŒ¹/g,'åŒ¹').replace(/åŒº/g,'å€').replace(/å/g,'å').replace(/å…/g,'å…').replace(/å‰/g,'å‰').replace(/å/g,'å').replace(/å‘/g,'å‘').replace(/å’/g,'å’').replace(/å“/g,'å“').replace(/å”/g,'å”').replace(/å•/g,'å–®').replace(/å–/g,'è³£').replace(/å—/g,'å—').replace(/åš/g,'åš').replace(/åœ/g,'åœ').replace(/å/g,'å').replace(/å¦/g,'å¦').replace(/å«/g,'è¡›').replace(/å¯/g,'å¯').replace(/å°/g,'å°').replace(/å±/g,'å±').replace(/å³/g,'å³').replace(/å·/g,'å·').replace(/å¸/g,'å¸').replace(/å‚/g,'å» ').replace(/å/g,'å').replace(/åŸ/g,'åŸ').replace(/å¢/g,'å»‚').replace(/å¦/g,'å»ˆ').replace(/å¨/g,'å»š').replace(/å©/g,'å»„').replace(/å•/g,'å»').replace(/å°/g,'å°').replace(/å¿/g,'ç¸£').replace(/å‚/g,'åƒ').replace(/åˆ/g,'åˆ').replace(/å‰/g,'å‰').replace(/åŠ/g,'åŠ').replace(/å‹/g,'å‹').replace(/å/g,'å').replace(/å‘/g,'ç™¼').replace(/å›/g,'å›').replace(/å–/g,'å–').replace(/å—/g,'å—').replace(/å£/g,'å£').replace(/å¤/g,'å¤').replace(/å¥/g,'å¥').replace(/å¦/g,'å¦').replace(/å©/g,'å©').replace(/åª/g,'åª').replace(/å«/g,'å«').replace(/å¬/g,'å¬').replace(/å®/g,'å®').replace(/å¯/g,'å¯').replace(/å°/g,'è‡º').replace(/å±/g,'å±').replace(/å²/g,'å²').replace(/å³/g,'å³').replace(/å¸/g,'å¸').replace(/åƒ/g,'åƒ').replace(/å„/g,'å„').replace(/å/g,'å').replace(/å/g,'å¾Œ').replace(/å/g,'å').replace(/å‘/g,'å‘').replace(/å“/g,'åš‡').replace(/å•/g,'å‘‚').replace(/å›/g,'å›').replace(/å/g,'å').replace(/å/g,'å').replace(/åŸ/g,'åŸ').replace(/å /g,'å ').replace(/å¦/g,'å¦').replace(/å«/g,'å«').replace(/å¬/g,'è½').replace(/å¯/g,'å•Ÿ').replace(/å´/g,'å³').replace(/åµ/g,'åµ').replace(/å¸/g,'å¸').replace(/å¹/g,'å¹').replace(/å»/g,'å»').replace(/å¼/g,'å¼').replace(/å’Œ/g,'å’Œ').replace(/å’/g,'è© ').replace(/å’’/g,'å’’').replace(/å’½/g,'å’½').replace(/å‘½/g,'å‘½').replace(/å’/g,'å’').replace(/å’¨/g,'å’¨').replace(/å“/g,'éŸ¿').replace(/å“/g,'å“').replace(/å“‘/g,'å•').replace(/å“/g,'å“').replace(/å’½/g,'å’½').replace(/éª‚/g,'ç½µ').replace(/åˆ«/g,'åˆ¥').replace(/å•/g,'å‘‚').replace(/å‘˜/g,'å“¡').replace(/åœ†/g,'åœ“').replace(/å”/g,'å”').replace(/é¦†/g,'é¤¨').replace(/èµ„/g,'è³‡').replace(/æ»/g,'æ»¯').replace(/æ»¡/g,'æ»¿').replace(/æ»¡è¶³/g,'æ»¿è¶³').replace(/æ¼‚/g,'æ¼‚').replace(/æ¼/g,'æ¼').replace(/æ¼”/g,'æ¼”').replace(/æ±‰/g,'æ¼¢').replace(/æ½®/g,'æ½®').replace(/æ¾ˆ/g,'æ¾ˆ').replace(/æµ/g,'æ¿Ÿ').replace(/æ´²/g,'æ´²').replace(/æµ‘/g,'æ¸¾').replace(/æµ…/g,'æ·º').replace(/æ³•/g,'æ³•').replace(/æ³ª/g,'æ·š').replace(/å†²/g,'æ²–').replace(/æ²¡/g,'æ²’').replace(/æ²³/g,'æ²³').replace(/æ²¸/g,'æ²¸').replace(/æ²¹/g,'æ²¹').replace(/æ²»/g,'æ²»').replace(/æ´/g,'æ½”').replace(/æ´ª/g,'æ´ª').replace(/æ´²/g,'æ´²').replace(/æµ/g,'æ¿Ÿ').replace(/æµ…/g,'æ·º').replace(/æµ‡/g,'æ¾†').replace(/æµŠ/g,'æ¿').replace(/æ´/g,'æ´').replace(/æ´’/g,'ç‘').replace(/ç‚¼/g,'ç…‰').replace(/ç‚¸/g,'ç‚¸').replace(/ç‚º/g,'ç‚º').replace(/ä¹Œ/g,'çƒ').replace(/ç…§/g,'ç…§').replace(/ç†Ÿ/g,'ç†Ÿ').replace(/çƒ­/g,'ç†±').replace(/ç‡ƒ/g,'ç‡ƒ').replace(/ç‡ˆ/g,'ç‡ˆ').replace(/ç‡’/g,'ç‡’').replace(/ç‡Ÿ/g,'ç‡Ÿ').replace(/çˆ±/g,'æ„›').replace(/çˆ·/g,'çˆº').replace(/çˆ¸çˆ¸å¦ˆå¦ˆ/g,'çˆ¸çˆ¸åª½åª½').replace(/å¦ˆ/g,'åª½').replace(/å§‘/g,'å§‘').replace(/å§/g,'å§').replace(/å§“/g,'å§“').replace(/å§”/g,'å§”').replace(/å­£/g,'å­£').replace(/å­¦/g,'å­¸').replace(/å®‡/g,'å®‡').replace(/å®ˆ/g,'å®ˆ').replace(/å®‰/g,'å®‰').replace(/å®Œ/g,'å®Œ').replace(/å®˜/g,'å®˜').replace(/å®š/g,'å®š').replace(/å®¢/g,'å®¢').replace(/å®³/g,'å®³').replace(/å®¶/g,'å®¶').replace(/å®¹/g,'å®¹').replace(/å®½/g,'å¯¬').replace(/å®¾/g,'è³“').replace(/å¯Œ/g,'å¯Œ').replace(/å¯/g,'å¯').replace(/å¯¹/g,'å°').replace(/å¯»/g,'å°‹').replace(/å¯¼/g,'å°').replace(/å¯¿/g,'å£½').replace(/å°†/g,'å°‡').replace(/å°/g,'å˜—').replace(/å°§/g,'å ¯').replace(/åˆ™/g,'å‰‡').replace(/åˆš/g,'å‰›').replace(/åˆ›/g,'å‰µ').replace(/åˆ˜/g,'åŠ‰').replace(/åˆ«/g,'åˆ¥').replace(/å‰‘/g,'åŠ').replace(/å‰¥/g,'å‰').replace(/å‰§/g,'åŠ‡').replace(/åŠ/g,'å‹¸').replace(/åŠ/g,'è¾¦').replace(/åŠ¡/g,'å‹™').replace(/åŠ¨/g,'å‹•').replace(/åŠ±/g,'å‹µ').replace(/åŠ²/g,'å‹').replace(/åŠ³/g,'å‹').replace(/å‹‡/g,'å‹‡').replace(/å‡/g,'å‡').replace(/å/g,'è¯').replace(/å/g,'å”').replace(/å–/g,'è³£').replace(/å—/g,'å—').replace(/åš/g,'åš').replace(/åœ/g,'åœ').replace(/å/g,'å').replace(/å¦/g,'å¦').replace(/å«/g,'è¡›').replace(/åµ/g,'åµ').replace(/å·/g,'å·').replace(/å¸/g,'å¸').replace(/å‚/g,'å» ').replace(/å/g,'å').replace(/åŸ/g,'åŸ').replace(/å¢/g,'å»‚').replace(/å¦/g,'å»ˆ').replace(/å¨/g,'å»š').replace(/å©/g,'å»„').replace(/å•/g,'å»').replace(/å¿/g,'ç¸£').replace(/å‚/g,'åƒ').replace(/åˆ/g,'åˆ').replace(/å‰/g,'å‰').replace(/åŠ/g,'åŠ').replace(/å‹/g,'å‹').replace(/å/g,'å').replace(/å‘/g,'ç™¼').replace(/å›/g,'å›').replace(/å–/g,'å–').replace(/å—/g,'å—').replace(/å£/g,'å£').replace(/å¤/g,'å¤').replace(/å¥/g,'å¥').replace(/å¦/g,'å¦').replace(/å©/g,'å©').replace(/åª/g,'åª').replace(/å«/g,'å«').replace(/å¬/g,'å¬').replace(/å®/g,'å®').replace(/å¯/g,'å¯'): '';
        
        try {
            let r = await fetch('https://v2.xxapi.cn/api/horoscope?type=' + zodiac + '&time=today');
            let d = await r.json();
            if (d.code === 200 && d.data) {
                horoscopeData = d.data;
                document.getElementById('horoName').textContent = s2t(d.data.title) || '';
                document.getElementById('scoreAll').textContent = d.data.index?.all || '-';
                document.getElementById('scoreLove').textContent = d.data.index?.love || '-';
                document.getElementById('scoreMoney').textContent = d.data.index?.money || '-';
                document.getElementById('scoreWork').textContent = d.data.index?.work || '-';
                document.getElementById('scoreHealth').textContent = d.data.index?.health || '-';
                document.getElementById('horoYi').textContent = 'å®œï¼š' + s2t(d.data.todo?.yi) || '-';
                document.getElementById('horoJi').textContent = 'å¿Œï¼š' + s2t(d.data.todo?.ji) || '-';
                document.getElementById('horoComment').textContent = s2t(d.data.shortcomment) || '';
            }
        } catch(e) {
            console.log('Horoscope API error:', e);
        }
    }
    
    function renderDailyLucky() {
        let today = new Date();
        let seed = today.getFullYear() * 10000 + (today.getMonth()+1) * 100 + today.getDate();
        let rng = function() { seed = (seed * 9301 + 49297) % 233280; return seed / 233280; };
        
        const config = LOTTO_CONFIG[currentType];
        let nums = [];
        while (nums.length < config.pickNum) {
            let n = Math.floor(rng() * config.maxNum) + 1;
            if (!nums.includes(n)) nums.push(n);
        }
        nums.sort((a,b) => a-b);
        
        document.getElementById('dailyLucky').innerHTML = nums.map(n => '<span style="margin:0 3px">' + n + '</span>').join('');
    }
    
    function generate() {
        const config = LOTTO_CONFIG[currentType];
        let { counter, hot, cold } = stats;
        let all = Array.from({length: config.maxNum}, (_,i) => i + 1);
        
        let hasCons = Math.random() < CONS_RATE;
        let hasRepeat = Math.random() < REPEAT_RATE;
        let selected = [];
        
        if (currentMode === 'hot') {
            selected = hot.slice(0, config.pickNum).sort((a,b) => a-b);
        } else if (currentMode === 'cold') {
            selected = cold.slice(0, config.pickNum).sort((a,b) => a-b);
        } else if (currentMode === 'drag' && data.length > 0) {
            let prev = data[data.length-1].drawNumberSize.slice(0, config.pickNum);
            selected = prev.slice(0, Math.min(3, prev.length));
        } else {
            if (hasRepeat && data.length > 0) {
                let prev = data[data.length-1].drawNumberSize.slice(0, config.pickNum);
                selected = prev.slice(0, Math.min(2, prev.length));
            }
            if (hasCons) {
                let base = Math.floor(Math.random() * (config.maxNum - 2)) + 1;
                if (!selected.includes(base)) selected.push(base);
                if (!selected.includes(base+1) && base < config.maxNum - 1) selected.push(base+1);
            }
        }
        
        while (selected.length < config.pickNum) {
            let idx = Math.floor(Math.random() * config.maxNum);
            let n = all[idx];
            if (!selected.includes(n)) selected.push(n);
        }
        
        selected = selected.slice(0, config.pickNum).sort((a,b) => a-b);
        
        if (config.special) {
            let avail = all.filter(n => !selected.includes(n));
            currentSpecial = avail[Math.floor(Math.random() * avail.length)];
        }
        
        // å¨åŠ›å½©ç¬¬äºŒå€
        if (config.special2) {
            currentSpecial2 = Math.floor(Math.random() * config.special2Max) + 1;
        }
        
        currentNums = selected;
        
        // è¨ˆç®—ç•¶æ¬¡ç”¢ç”Ÿçš„å¥‡å¶æ¯”ä¾‹
        let oddCount = selected.filter(n => n % 2 === 1).length;
        let evenCount = selected.length - oddCount;
        let oddPct = (oddCount / selected.length * 100);
        let evenPct = (evenCount / selected.length * 100);
        document.getElementById('oddBar').style.height = oddPct + '%';
        document.getElementById('evenBar').style.height = evenPct + '%';
        document.getElementById('oddCount').textContent = oddCount + ' (' + Math.round(oddPct) + '%)';
        document.getElementById('evenCount').textContent = evenCount + ' (' + Math.round(evenPct) + '%)';
        
        document.getElementById('numbers').innerHTML = selected.map(n => '<div class="ball">' + n + '</div>').join('');
        document.getElementById('special').textContent = config.special ? currentSpecial : '-';
        
        // ç¬¬äºŒå€é¡¯ç¤º
        const special2Zone = document.getElementById('special2Zone');
        const special2El = document.getElementById('special2');
        if (config.special2) {
            special2Zone.style.display = 'inline';
            special2El.textContent = currentSpecial2;
        } else {
            special2Zone.style.display = 'none';
        }
        
        document.getElementById('consTag').className = 'tag ' + (hasCons ? 'tag-yes' : 'tag-no');
        document.getElementById('consTag').textContent = hasCons ? 'âœ… æœ‰é€£è™Ÿ' : 'âŒ ç„¡é€£è™Ÿ';
        document.getElementById('repeatTag').className = 'tag ' + (hasRepeat ? 'tag-yes' : 'tag-no');
        document.getElementById('repeatTag').textContent = hasRepeat ? 'âœ… åƒè€ƒä¸ŠæœŸ' : 'âŒ å…¨æ–°çµ„åˆ';
        
        // æ›´æ–°è¶¨å‹¢åœ–ç‚ºç•¶æ¬¡ç”¢ç”Ÿçš„è™Ÿç¢¼
        updateTrendChartForNumbers(selected);
    }
    
    function saveFav() {
        let favs = JSON.parse(localStorage.getItem('lotto_favs') || '[]');
        favs.unshift({ type: currentType, nums: [...currentNums], special: currentSpecial, special2: currentSpecial2 });
        favs = favs.slice(0, 20);
        localStorage.setItem('lotto_favs', JSON.stringify(favs));
        renderFavorites();
    }
    
    function renderFavorites() {
        let favs = JSON.parse(localStorage.getItem('lotto_favs') || '[]');
        let el = document.getElementById('favList');
        if (favs.length === 0) {
            el.innerHTML = '<p style="color:#aaa;text-align:center;font-size:0.85em;">å°šç„¡æ”¶è—</p>';
            return;
        }
        el.innerHTML = favs.map(function(f, i) {
            let specHtml = f.special ? '<span style="color:#f55768">â­' + f.special + '</span>' : '';
            let spec2Html = f.special2 ? '<span style="color:#ffd700">ï½œ' + f.special2 + '</span>' : '';
            return '<div class="fav-item"><span>' + f.nums.join(', ') + ' ' + specHtml + spec2Html + '</span><button class="del-btn" onclick="delFav(' + i + ')">åˆª</button></div>';
        }).join('');
    }
    
    function delFav(i) {
        let favs = JSON.parse(localStorage.getItem('lotto_favs') || '[]');
        favs.splice(i, 1);
        localStorage.setItem('lotto_favs', JSON.stringify(favs));
        renderFavorites();
    }
    </script>
</body>
</html>
