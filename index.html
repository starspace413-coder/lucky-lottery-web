<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° æ¨‚é€å¹¸é‹è™Ÿç¢¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); min-height: 100vh; padding: 15px; color: #fff; }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; font-size: 1.8em; background: linear-gradient(45deg, #ffd700, #ff8c00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 12px; }
        .mode-btns { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; }
        .mode-btn { flex: 1; min-width: 60px; padding: 10px 5px; border: 2px solid transparent; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; cursor: pointer; font-size: 0.8em; }
        .mode-btn.active { border-color: #ffd700; background: rgba(255,215,0,0.2); }
        .numbers { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .ball { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; background: linear-gradient(145deg, #667eea, #764ba2); animation: float 2s infinite; }
        .ball.special { background: linear-gradient(145deg, #f093fb, #f5576c); }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
        .special-text { text-align: center; color: #f5576c; font-weight: bold; margin-top: 8px; }
        .btn { background: linear-gradient(45deg, #ffd700, #ff8c00); border: none; padding: 12px 25px; font-size: 1em; border-radius: 20px; cursor: pointer; color: #1a1a2e; font-weight: bold; margin: 5px; }
        .btn-outline { background: transparent; border: 2px solid #ffd700; color: #ffd700; }
        .tags { text-align: center; margin-top: 10px; }
        .tag { display: inline-block; padding: 5px 10px; border-radius: 12px; font-size: 0.75em; margin: 2px; }
        .tag-yes { background: rgba(0,255,127,0.2); color: #00ff7f; }
        .tag-no { background: rgba(255,99,71,0.2); color: #ff6347; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2em; font-weight: bold; color: #ffd700; }
        .stat-label { font-size: 0.7em; color: #aaa; }
        .num-list { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
        .num-tag { padding: 4px 8px; border-radius: 10px; font-size: 0.75em; }
        .num-hot { background: rgba(255,107,107,0.3); color: #ff6b6b; }
        .num-cold { background: rgba(78,205,196,0.3); color: #4ecdc4; }
        .fav-item { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { background: rgba(255,99,71,0.3); border: none; color: #ff6347; padding: 4px 8px; border-radius: 8px; cursor: pointer; }
        .tips { text-align: center; color: #666; font-size: 0.65em; margin-top: 15px; padding: 10px; background: rgba(255,0,0,0.1); border-radius: 8px; }
        .chart-container { position: relative; height: 200px; margin-top: 10px; }
        .trend-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .trend-controls { display: flex; gap: 5px; }
        .trend-btn { padding: 4px 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: transparent; color: #aaa; font-size: 0.7em; cursor: pointer; }
        .trend-btn.active { border-color: #ffd700; color: #ffd700; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° æ¨‚é€å¹¸é‹è™Ÿç¢¼</h1>
        
        <div class="card">
            <div style="font-size:0.75em;color:#aaa;text-align:center;margin-bottom:10px;">
                ğŸ“Š æ¡ç”¨çµ±è¨ˆè«–æ–‡æ¨¡å‹ | é€£è™Ÿæ©Ÿç‡ 56% | é‡è¤‡æ©Ÿç‡ 20%
            </div>
            <div class="mode-btns">
                <button class="mode-btn active" data-mode="balanced">âš–ï¸å¹³è¡¡</button>
                <button class="mode-btn" data-mode="hot">ğŸ”¥ç†±é–€</button>
                <button class="mode-btn" data-mode="cold">â„ï¸å†·é–€</button>
                <button class="mode-btn" data-mode="drag">ğŸ“Œæ‹–ç‰Œ</button>
            </div>
            
            <div class="numbers" id="numbers"></div>
            <p class="special-text">â­ ç‰¹åˆ¥è™Ÿ: <span id="special">-</span></p>
            
            <div class="tags">
                <span class="tag" id="consTag"></span>
                <span class="tag" id="repeatTag"></span>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn" id="genBtn">ğŸ”„ é‡æ–°ç”¢ç”Ÿ</button>
                <button class="btn btn-outline" id="favBtn">â¤ï¸æ”¶è—</button>
            </div>
        </div>
        
        <div class="card">
            <div class="stats">
                <div class="stat"><div class="stat-val" id="consRate">-</div><div class="stat-label">é€£è™Ÿæ©Ÿç‡</div></div>
                <div class="stat"><div class="stat-val" id="repeatRate">-</div><div class="stat-label">é‡è¤‡æ©Ÿç‡</div></div>
                <div class="stat"><div class="stat-val" id="totalDraws">-</div><div class="stat-label">åˆ†ææœŸæ•¸</div></div>
            </div>
        </div>
        
        <div class="card">
            <div class="trend-title">
                <div style="font-size:0.9em;">ğŸ“ˆ è¶¨å‹¢åœ–ï¼ˆæ»‘å‹•çª—å€é–“çµ±è¨ˆï¼‰</div>
                <div class="trend-controls">
                    <button class="trend-btn active" data-num="hot">ğŸ”¥ç†±é–€</button>
                    <button class="trend-btn" data-num="cold">â„ï¸å†·é–€</button>
                </div>
            </div>
            <div style="font-size:0.65em;color:#888;margin-bottom:5px;">æ©«è»¸ï¼šæœŸæ•¸ï¼ˆèˆŠâ†’æ–°ï¼‰ | ç¸±è»¸ï¼šé–‹å‡ºæ¬¡æ•¸ | ç¶ ç·šï¼šå¹³å‡</div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div style="font-size:0.9em;margin-bottom:8px;">ğŸ”¥ ç†±é–€è™Ÿç¢¼ TOP10</div>
            <div class="num-list" id="hotNums"></div>
        </div>
        
        <div class="card">
            <div style="font-size:0.9em;margin-bottom:8px;">â„ï¸ å†·é–€è™Ÿç¢¼ TOP10</div>
            <div class="num-list" id="coldNums"></div>
        </div>
        
        <div class="card">
            <div style="font-size:0.9em;margin-bottom:8px;">â¤ï¸ æˆ‘çš„æ”¶è—</div>
            <div id="favList"></div>
        </div>
        
        <div class="tips">âš ï¸ æ¨‚é€ç‚ºå®Œå…¨éš¨æ©Ÿï¼Œæ­¤åƒ…ä¾›å¨›æ¨‚åƒè€ƒ</div>
    </div>

    <script>
        // æ•¸æ“š
        let data = [];
        let stats = { counter: {}, hot: [], cold: [], trends: {} };
        let currentMode = 'balanced';
        let currentTrendNum = 'hot';
        let currentNums = [];
        let currentSpecial = 0;
        let chart = null;
        
        // è«–æ–‡åƒæ•¸
        const CONS_RATE = 0.56;
        const REPEAT_RATE = 0.20;
        const WINDOW_SIZE = 20;  // æ»‘å‹•çª—å¯¬åº¦
        const REF_POINTS = 20;    // åƒè€ƒé»æ•¸
        
        // åˆå§‹åŒ–
        init();
        
        async function init() {
            await loadData();
            analyze();
            generate();
            renderFavorites();
            renderTrendChart();
            
            // æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    generate();
                };
            });
            
            // è¶¨å‹¢åœ–åˆ‡æ›
            document.querySelectorAll('.trend-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.trend-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTrendNum = btn.dataset.num;
                    updateTrendChart();
                };
            });
            
            document.getElementById('genBtn').onclick = generate;
            document.getElementById('favBtn').onclick = saveFav;
        }
        
        async function loadData() {
            const months = ['2025-09','2025-10','2025-11','2025-12','2026-01','2026-02'];
            
            for (let m of months) {
                try {
                    let r = await fetch(`https://api.taiwanlottery.com/TLCAPIWeB/Lottery/Lotto649Result?period&month=${m}&pageNum=1&pageSize=50`);
                    let d = await r.json();
                    if (d.content && d.content.lotto649Res) {
                        data.push(...d.content.lotto649Res);
                    }
                } catch(e) {}
            }
            
            // ä¾æœŸæ•¸æ’åºï¼ˆèˆŠåˆ°æ–°ï¼‰
            data.sort((a, b) => a.lottoPeriodNo - b.lottoPeriodNo);
            
            if (data.length < 10) {
                // é›¢ç·šæ¨£æœ¬
                for (let i = 0; i < 50; i++) {
                    let nums = [];
                    while (nums.length < 6) {
                        let n = Math.floor(Math.random() * 49) + 1;
                        if (!nums.includes(n)) nums.push(n);
                    }
                    data.push({
                        drawNumberSize: [...nums.sort((a,b)=>a-b), Math.floor(Math.random() * 49) + 1]
                    });
                }
            }
        }
        
        function analyze() {
            let main = [], special = [], cons = 0, repeat = 0, prev = null;
            
            data.forEach(d => {
                let nums = d.drawNumberSize || [];
                if (nums.length >= 7) {
                    let m = nums.slice(0,6).sort((a,b)=>a-b);
                    main.push(...m);
                    special.push(nums[6]);
                    
                    // é€£è™Ÿ
                    for (let i = 0; i < m.length-1; i++) {
                        if (m[i+1] - m[i] === 1) cons++;
                    }
                    // é‡è¤‡
                    if (prev) {
                        let c = m.filter(x => prev.includes(x)).length;
                        if (c >= 2) repeat++;
                    }
                    prev = m;
                }
            });
            
            // è¨ˆæ•¸
            let counter = {};
            main.forEach(n => counter[n] = (counter[n] || 0) + 1);
            
            // æ’åº
            let sorted = Object.entries(counter).sort((a,b) => b[1] - a[1]);
            stats = { counter, hot: sorted.slice(0,10).map(x=>parseInt(x[0])), cold: sorted.slice(-10).reverse().map(x=>parseInt(x[0])), trends: {} };
            
            // æ»‘å‹•çª—å€é–“çµ±è¨ˆ
            calculateTrends();
            
            // é¡¯ç¤º
            document.getElementById('consRate').textContent = (cons / data.length * 100).toFixed(1) + '%';
            document.getElementById('repeatRate').textContent = (repeat / (data.length-1) * 100).toFixed(1) + '%';
            document.getElementById('totalDraws').textContent = data.length;
            document.getElementById('hotNums').innerHTML = stats.hot.map(n => `<span class="num-tag num-hot">${n}</span>`).join('');
            document.getElementById('coldNums').innerHTML = stats.cold.map(n => `<span class="num-tag num-cold">${n}</span>`).join('');
        }
        
        // æ»‘å‹•çª—å€é–“çµ±è¨ˆæ³•
        function calculateTrends() {
            let mainNums = data.map(d => (d.drawNumberSize || []).slice(0,6)).filter(n => n.length >= 6);
            let totalPeriods = mainNums.length;
            
            // å°æ¯å€‹è™Ÿç¢¼è¨ˆç®—æ»‘å‹•çª—è¶¨å‹¢
            for (let num = 1; num <= 49; num++) {
                let trends = [];
                
                // ç”¢ç”Ÿåƒè€ƒé»
                for (let i = 0; i < REF_POINTS; i++) {
                    let start = Math.max(0, totalPeriods - WINDOW_SIZE - i);
                    let end = totalPeriods - i;
                    
                    if (start < end) {
                        let count = 0;
                        for (let j = start; j < end; j++) {
                            if (mainNums[j].includes(num)) count++;
                        }
                        trends.push(count);
                    }
                }
                
                if (trends.length > 0) {
                    stats.trends[num] = trends;
                }
            }
        }
        
        function renderTrendChart() {
            let ctx = document.getElementById('trendChart').getContext('2d');
            
            let numbers = currentTrendNum === 'hot' ? stats.hot.slice(0,5) : stats.cold.slice(0,5);
            let datasets = numbers.map((num, i) => {
                let trend = stats.trends[num] || [];
                let color = currentTrendNum === 'hot' ? 
                    `rgba(255, ${100 + i*30}, ${100 + i*30}, 1)` : 
                    `rgba(78, ${205 - i*20}, ${196 - i*20}, 1)`;
                return {
                    label: 'è™Ÿç¢¼ ' + num,
                    data: trend,
                    borderColor: color,
                    backgroundColor: color.replace('1)', '0.1)'),
                    fill: true,
                    tension: 0.3,
                    borderWidth: 2
                };
            });
            
            // å¹³å‡ç·š
            let avgData = [];
            if (datasets.length > 0 && datasets[0].data.length > 0) {
                let len = datasets[0].data.length;
                for (let i = 0; i < len; i++) {
                    let sum = datasets.reduce((acc, d) => acc + (d.data[i] || 0), 0);
                    avgData.push(sum / datasets.length);
                }
            }
            
            let labels = datasets.length > 0 ? 
                datasets[0].data.map((_, i) => `æœŸ${i+1}`) : [];
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        ...datasets,
                        {
                            label: 'å¹³å‡',
                            data: avgData,
                            borderColor: 'rgba(0, 255, 127, 0.8)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#aaa', boxWidth: 12, font: { size: 10 } }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888', font: { size: 9 } },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: {
                            ticks: { color: '#888', font: { size: 9 } },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateTrendChart() {
            if (chart) {
                chart.destroy();
            }
            renderTrendChart();
        }
        
        function generate() {
            let { counter, hot, cold } = stats;
            let all = Array.from({length: 49}, (_,i) => i + 1);
            let weights = all.map(n => (counter[n] || 0) + 1);
            
            // è«–æ–‡æ¨¡å‹
            let hasCons = Math.random() < CONS_RATE;
            let hasRepeat = Math.random() < REPEAT_RATE;
            
            let selected = [];
            
            // æ¨¡å¼é¸æ“‡
            if (currentMode === 'hot') {
                selected = hot.slice(0,6).sort((a,b) => a-b);
            } else if (currentMode === 'cold') {
                selected = [...cold].slice(0,6).sort((a,b) => a-b);
            } else if (currentMode === 'drag' && data.length > 0) {
                let prev = data[data.length-1].drawNumberSize.slice(0,6);
                selected = prev.slice(0, Math.min(3, prev.length));
            } else {
                // balanced
                if (hasRepeat && data.length > 0) {
                    let prev = data[data.length-1].drawNumberSize.slice(0,6);
                    selected = prev.slice(0, Math.min(2, prev.length));
                }
                if (hasCons) {
                    let base = Math.floor(Math.random() * 48) + 1;
                    if (!selected.includes(base)) selected.push(base);
                    if (!selected.includes(base+1) && base < 49) selected.push(base+1);
                }
            }
            
            // è£œæ»¿6å€‹
            while (selected.length < 6) {
                let idx = Math.floor(Math.random() * 49);
                let n = all[idx];
                if (!selected.includes(n)) selected.push(n);
            }
            
            selected = selected.slice(0,6).sort((a,b) => a-b);
            
            // ç‰¹åˆ¥è™Ÿ
            let avail = all.filter(n => !selected.includes(n));
            let specIdx = Math.floor(Math.random() * avail.length);
            currentSpecial = avail[specIdx];
            
            currentNums = selected;
            
            // é¡¯ç¤º
            document.getElementById('numbers').innerHTML = selected.map(n => `<div class="ball">${n}</div>`).join('');
            document.getElementById('special').textContent = currentSpecial;
            
            document.getElementById('consTag').className = 'tag ' + (hasCons ? 'tag-yes' : 'tag-no');
            document.getElementById('consTag').textContent = hasCons ? 'âœ… æœ‰é€£è™Ÿ' : 'âŒ ç„¡é€£è™Ÿ';
            document.getElementById('repeatTag').className = 'tag ' + (hasRepeat ? 'tag-yes' : 'tag-no');
            document.getElementById('repeatTag').textContent = hasRepeat ? 'âœ… åƒè€ƒä¸ŠæœŸ' : 'âŒ å…¨æ–°çµ„åˆ';
        }
        
        function saveFav() {
            let favs = JSON.parse(localStorage.getItem('lotto_favs') || '[]');
            favs.unshift({ nums: [...currentNums], special: currentSpecial });
            favs = favs.slice(0, 20);
            localStorage.setItem('lotto_favs', JSON.stringify(favs));
            renderFavorites();
        }
        
        function renderFavorites() {
            let favs = JSON.parse(localStorage.getItem('lotto_favs') || '[]');
            let el = document.getElementById('favList');
            if (favs.length === 0) {
                el.innerHTML = '<p style="color:#aaa;text-align:center;font-size:0.85em;">å°šç„¡æ”¶è—</p>';
                return;
            }
            el.innerHTML = favs.map((f, i) => `
                <div class="fav-item">
                    <span>${f.nums.join(', ')} <span style="color:#f55768">â­${f.special}</span></span>
                    <button class="del-btn" onclick="delFav(${i})">åˆª</button>
                </div>
            `).join('');
        }
        
        function delFav(i) {
            let favs = JSON.parse(localStorage.getItem('lotto_favs') || '[]');
            favs.splice(i, 1);
            localStorage.setItem('lotto_favs', JSON.stringify(favs));
            renderFavorites();
        }
    </script>
</body>
</html>
